image: amazon/aws-cli
pipelines:
  branches:
    staging:
      - step:
          name: Test
          image: golang:1.21.0
          script:
            - make test
      - step:
          name: Build and Publish
          services:
            - docker
          script:
            - export REPO_NAME=registry.qiscus.com/integration/
            - export PROJECT_NAME=integration-go-stag
            - export IMAGE_TAG="${REPO_NAME}""${PROJECT_NAME}":"${BITBUCKET_BUILD_NUMBER}"
            - docker build -t ${IMAGE_TAG} .
            - echo ${HARBOR_PASSWORD} | docker login registry.qiscus.com --username ${HARBOR_USER} --password-stdin
            - docker push "${IMAGE_TAG}"
            - echo ${IMAGE_TAG}
options:
  docker: true
